---
title: 'ãƒã‚§ã‚¹ã‚¢ãƒ—ãƒªé–‹ç™º(8) ãƒã‚¦ã‚¹æ“ä½œã§é§’ã‚’å‹•ã‹ã™'
date: 2020-04-02T18:00:00+09:00
lastmod: 2020-12-16T18:00:00+09:00
topics: [ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°, Python, OpenGL, ã‚¢ãƒ—ãƒªé–‹ç™º, ãƒã‚§ã‚¹]
katex: true
published: true
---

Python ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å‹•ã‹ã™ãƒ•ã‚§ã‚¢ãƒªãƒ¼ãƒã‚§ã‚¹ã‚¢ãƒ—ãƒªé–‹ç™ºã€é€£è¼‰ç¬¬ï¼˜å›ã§ã™ã€‚

<pstlk label="å‰å›" to="chess-app-devel-7" />ã¯
<tltp label="Pillow">Python ã®ç”»åƒå‡¦ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</tltp>
ã§ç”»åƒã‚’èª­ã¿è¾¼ã¿ã€ç›¤é¢ä¸Šã«é§’ã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚

ä»Šå›ã¯ãƒã‚¦ã‚¹æ“ä½œã§é§’ã‚’å‹•ã‹ã›ã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ã€‚

<!--more-->

<br/>

## å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸

<postimage src="goal" ext="gif" alt="å®Œæˆå›³" />

é§’ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ç§»å‹•å¯èƒ½ãªãƒã‚¹ãŒè¡¨ç¤ºã•ã‚Œã€ç§»å‹•å…ˆã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãã“ã«ç§»å‹•ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

<br/>

## ä¸¸ã®æç”»

é§’ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ä¸¸ã‚’è¡¨ç¤ºã™ã‚‹ã®ã§ã€ä¸¸ã‚’æç”»ã™ã‚‹é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚

```py name=utils.py
from math import pi, sin, cos
ã€€
...
ã€€
def circle(x, y, opponent, r=0.25):
    '''
    å††ã‚’æç”»ã™ã‚‹

    Parameters
    ----------
    x, y : float
        ä¸­å¿ƒã®åº§æ¨™ï¼
    opponent : bool
        True ã®ã¨ãï¼Œèµ¤è‰²ã§æç”»ã™ã‚‹ï¼
    r : float, default 0.25
        åŠå¾„ï¼
    '''
    glPushMatrix()          # å¤‰å½¢ç¯„å›²ã®é–‹å§‹
    glTranslate(x, y, 0)    # å¹³è¡Œç§»å‹•

    # è‰²ã®æŒ‡å®š
    if opponent:
        glColor(1.0, 0.5, 0.5, 0.7)     # èµ¤
    else:
        glColor(0.5, 0.5, 1.0, 0.7)     # é’

    # å††ã®æç”»
    glBegin(GL_POLYGON)     # å¤šè§’å½¢ã®æç”»
    for k in range(12):
        xr = r * cos(2 * pi * k / 12)
        yr = r * sin(2 * pi * k / 12)
        glVertex(xr, yr, 0)
    glEnd()
    ã€€
    glPopMatrix()           # å¤‰å½¢ç¯„å›²ã®çµ‚äº†
```

å††ã®æç”»ã¨ã—ã¦ã„ã¾ã™ãŒã€å®Ÿã¯æ­£åäºŒè§’å½¢ã‚’æç”»ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

æ•°å­¦ã®è©±ã«ãªã‚Šã¾ã™ãŒã€ä¸‰è§’é–¢æ•°ã®å¼•æ•°ã¯
<tltp label="å¼§åº¦æ³•">åº¦æ•°æ³•ã« 180 ã§å‰²ã£ã¦å††å‘¨ç‡ã‚’ã‹ã‘ãŸã‚‚ã®</tltp>
ã§è¡¨ã•ã‚Œã‚‹ã®ã§ã€

360 åº¦ã¯å††å‘¨ç‡ã® 2 å€ã®å€¤ï¼ˆ$2\pi$ï¼‰ã«ãªã‚Šã¾ã™ã€‚

è§’åº¦ã¨åº§æ¨™ã®é–¢ä¿‚ã¯æ¬¡ã®å›³ã®ã‚ˆã†ã«ãªã‚‹ã®ã§ã€

30-31 è¡Œç›®ã®ã‚ˆã†ãªå¼ãŒå‡ºæ¥ä¸ŠãŒã‚Šã¾ã™ã€‚

<postimage src="sin-cos" ext="png" alt="è§’åº¦ã¨åº§æ¨™" />

<br/>

## ãƒã‚¦ã‚¹ãƒã‚¤ãƒ³ã‚¿åº§æ¨™ã®å–å¾—

OpenGL ã§ã¯ã€`glutMouseFunc()` ã«ãƒ¦ãƒ¼ã‚¶å®šç¾©ã®é–¢æ•°ã‚’ç™»éŒ²ã—ã¦ãŠã‘ã°ã€

**ãƒã‚¦ã‚¹ã®ã©ã®ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œé›¢ã•ã‚ŒãŸã‹ã€ãã®ã¨ãã®ãƒã‚¦ã‚¹ãƒã‚¤ãƒ³ã‚¿ã®ä½ç½®ã¯ã©ã“ã‹ãªã©ã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã™ã€‚**

ãƒã‚¦ã‚¹ã§å‹•ä½œã‚’åˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ãŸã‚ã®é–¢æ•°ã‚„ã€

ç›¤é¢ãŒç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã«ç›¤é¢ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ã¯æ¶ˆã—ã¦ã—ã¾ã„ã¾ã™ã€‚

ï¼ˆèµ¤ã¯å‰Šé™¤è¡Œã§ã™ã€‚å¯èª­æ€§ã®ãŸã‚ã€ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹ CamelCase ã‹ã‚‰ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹ snake_case ã«å¤‰æ›´ã™ã‚‹ãªã©ã€è¡¨è¨˜ã‚’å¤‰ãˆãŸéƒ¨åˆ†ãŒã‚ã‚Šã¾ã™ã€‚ï¼‰

```py name=main.py ins=4-9,18-20,44-52,56-93,99 del=13,16-17,22-43 inline_hl=16:4-8;18:4-10
class Game:
    def __init__(self):
        ...
        # ãƒã‚¦ã‚¹ãƒã‚¤ãƒ³ã‚¿ã®ä½ç½®
        self.mousepos = [-1.0, -1.0]
        # è¡Œå…ˆã®æŒ‡å®š
        self.select_dest = False
        # å§‹ç‚¹ãƒ»çµ‚ç‚¹
        self.startpos, self.endpos = (None, None), (None, None)
        ...
    ...
    def main(self):
        self.printBoard()
        print(self.message)
        self.message = ""
        startpos, endpos = self.parseInput()
        ...
        startpos, endpos = self.startpos, self.endpos
        if None not in startpos + endpos:
            ...
	...
    def parseInput(self):
        try:
            a,b = input().split()
            a = ((ord(a[0])-97), int(a[1])-1)
            b = (ord(b[0])-97, int(b[1])-1)
            print(a,b)
            return (a,b)
        except:
            print("error decoding input. please try again")
            return((-1,-1),(-1,-1))
ã€€
    def printBoard(self):
        print("  1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 |")
        for i in range(0,8):
            print("-"*32)
            print(chr(i+97),end="|")
            for j in range(0,8):
                item = self.gameboard.get((i,j)," ")
                print(str(item)+' |', end = " ")
            print()
        print("-"*32)
ã€€
    def parse_mouse(self):
        '''ãƒã‚¦ã‚¹ãƒã‚¤ãƒ³ã‚¿ã®ä½ç½®ã‹ã‚‰æŒ‡å®šã—ãŸãƒã‚¹ç›®ã‚’å‡ºåŠ›'''
        a, b = self.mousepos
        file_, rank = None, None
        for i in range(8):
            if abs(a - i) < 0.5: file_ = i
        for i in range(8):
            if abs(b - i) < 0.5: rank = i
        return (file_, rank)
ã€€
	...
ã€€
    def mouse(self, button, state, x, y):
        '''
        ãƒã‚¦ã‚¹å…¥åŠ›ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯

        Parameters
        ----------
        button : GLUT_LEFT_BUTTON, GLUT_MIDDLE_BUTTON, GLUT_RIGHT_BUTTON or int > 0, 1, 2
            ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ï¼
            GLUT_LEFT_BUTTON, 0 -- å·¦
            GLUT_MIDDLE_BUTTON, 1 -- ä¸­
            GLUT_RIGHT_BUTTON, 2 -- å³
        state : GLUT_DOWN, GLUT_UP or int > 0, 1
            ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ï¼
            GLUT_DOWN, 0 -- æŠ¼ã•ã‚ŒãŸ
            GLUT_UP, 1 -- é›¢ã•ã‚ŒãŸ
        x, y : int
            ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åº§æ¨™ï¼
        '''
        # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åº§æ¨™ã‚’ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã«å¤‰æ›ã™ã‚‹
        self.mousepos = window2world(x, y, WSIZE)
        # å·¦ã‚¯ãƒªãƒƒã‚¯
        if (button == GLUT_LEFT_BUTTON
                and state == GLUT_DOWN):
            try:
                # è¡Œå…ˆé¸æŠ
                if (self.select_dest
                        and self.is_valid_move(self.gameboard[self.startpos],
                            self.startpos, self.parse_mouse(), self.gameboard)):
                    self.select_dest = False
                    self.endpos = self.parse_mouse()
                # é§’é¸æŠ
                elif self.parse_mouse() in self.gameboard:
                    self.startpos, self.endpos = (None, None), (None, None)
                    self.select_dest = True
                    self.startpos = self.parse_mouse()
            except KeyError: pass
ã€€ã€€
            glutPostRedisplay()     # å†æç”»
ã€€
    ...
ã€€
    def glmain(self):
        ...
        glutMouseFunc(self.mouse) 	# ãƒã‚¦ã‚¹å…¥åŠ›ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
        ...
```

ã‚¯ãƒªãƒƒã‚¯æ“ä½œã‚’ã™ã‚‹ãŸã³ã«`mouse()`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã¦å‡¦ç†ã‚’ã—ã¾ã™ã€‚

`parse_mouse()`ã§ã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒã‚¦ã‚¹ãƒã‚¤ãƒ³ã‚¿ã®ä½ç½®ã‚’ã‚‚ã¨ã«ç›¤é¢ä¸Šã®ã©ã®ãƒã‚¹ãŒæŒ‡å®šã•ã‚ŒãŸã‹ã‚’å‡ºåŠ›ã—ã€

é§’ã‚„ãã®ç§»å‹•å…ˆã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

äºˆæœŸã›ã¬å ´æ‰€ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®ãŸã‚ã«ã€`try-except`ã§ä¾‹å¤–å‡¦ç†ã‚’ã—ã¦ã„ã¾ã™ã€‚

[`glutPostRedisplay()`](http://wisdom.sakura.ne.jp/system/opengl/gl10.html)ã¯ç”»é¢ã®å†æç”»ã‚’è¡Œã†é–¢æ•°ã§ã€`draw()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

19 è¡Œç›®ã®`if None not in startpos + endpos:`ã¯ã€é–‹å§‹ä½ç½®ã¨çµ‚äº†ä½ç½®ã®ä¸¡æ–¹ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

### ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åº§æ¨™ã‚’ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã«å¤‰æ›

`mouse()`ãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹`x, y`ã¯**ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åº§æ¨™**ã§ã™ã€‚

ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åº§æ¨™ã¯ã€è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å·¦ä¸Šã‚’(0, 0)ã¨ã—ã€ãƒ”ã‚¯ã‚»ãƒ«ã‚’å˜ä½ã¨ã™ã‚‹åº§æ¨™ç³»ã§ã™ã€‚

ã¤ã¾ã‚Šã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚µã‚¤ã‚ºã‚’ 600x400 ã ã¨ã™ã‚‹ã¨ã€å³ä¸‹ã®åº§æ¨™ã¯(600, 400)ã¨ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã«å¯¾ã—ã¦ã€å®Ÿéš›ã«æç”»ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã®ã¯**ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™**ã§ã™ã€‚

ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã¯ãƒ¦ãƒ¼ã‚¶ãŒå®šç¾©ã§ãã¾ã™ã€‚

<pstlk label="ç¬¬6å›" to="chess-app-devel-6#å››è§’å½¢ã®æç”»" />ã§
<icode>glOrtho()</icode>ã‚’ä½¿ã£ã¦æŒ‡å®šã—ã¦ã„ã‚‹ã®ã‚‚ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã§ã™ã€‚

ã•ã¦ã€å®Ÿéš›ã«ãƒã‚¦ã‚¹ãƒã‚¤ãƒ³ã‚¿ã®ä½ç½®ã‚’æƒ…å ±ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã«ã‚ãŸã£ã¦ã¯ã€

**ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã«å¤‰æ›ã—ãŸã»ã†ãŒä½•ã‹ã¨ä¾¿åˆ©**ã§ã™ã€‚

ãã“ã§ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åº§æ¨™ã‚’ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã«å¤‰æ›ã™ã‚‹é–¢æ•°ã‚’ä½œã‚Šã¾ã™ã€‚

```py name=utils.py
def window2world(x, y, wsize):
    '''
    ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åº§æ¨™ã‚’ä¸–ç•Œåº§æ¨™ã«å¤‰æ›ã™ã‚‹

    Parameters
    ----------
    x, y : int
        å¤‰æ›ã™ã‚‹ã‚‚ã¨ã®åº§æ¨™ï¼
    wsize : int
        ç”»é¢ã®å¤§ãã•ï¼

    Returns
    -------
    list > [float, float]
        å¤‰æ›å…ˆã®åº§æ¨™ï¼
    '''
    return [9*x / wsize - 1, 7 - (9*y / wsize - 1)]
```

ã“ã®å¤‰æ›ã«ã‚ˆã£ã¦ã€å·¦ä¸‹ç«¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ã¯(-1, -1)ã¨ã„ã†åº§æ¨™ãŒã€å³ä¸Šç«¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ã¯(8, 8)ã¨ã„ã†åº§æ¨™ãŒå–å¾—ã§ãã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

<postimage src="world_coord" ext="png" alt="ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™" />

<br/>

## ç§»å‹•å¯èƒ½ãªãƒã‚¹ã«ä¸¸ã‚’è¡¨ç¤º

ã•ãã»ã©å®šç¾©ã—ãŸä¸¸ã‚’æç”»ã™ã‚‹é–¢æ•°ã‚’ä½¿ã£ã¦ã€é§’ã‚’æŒ‡å®šã—ãŸã¨ãã«ãã®é§’ãŒç§»å‹•å¯èƒ½ãªãƒã‚¹ã«ä¸¸ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã¾ãšã¯ã€æŒ‡å®šã•ã‚ŒãŸä½ç½®ã™ã¹ã¦ã«ä¸¸ã‚’æç”»ã™ã‚‹é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚

```py name=utils.py
def draw_available_moves(poslist, opponent=None):
    '''å‹•ã‹ã›ã‚‹ä½ç½®ã‚’æç”»ã™ã‚‹

    Parameters
    ----------
    poslist : list > [(int, int), ...]
        ç§»å‹•å…ˆã®åº§æ¨™ã®ãƒªã‚¹ãƒˆï¼
    opponent : bool or None, default None
        True ã®ã¨ãï¼Œèµ¤è‰²ã§æç”»ã™ã‚‹ï¼
    '''
    for pos in poslist:
        circle(*pos, opponent)
```

`*pos`ã¯ã‚¢ãƒ³ãƒ‘ãƒƒã‚¯ã¨ã„ã†ã‚‚ã®ã§ã€`pos`ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ãã‚Œãã‚Œã‚’ãã®ã¾ã¾é–¢æ•°ã®å¼•æ•°ã«æ¸¡ã™ãŸã‚ã«ä½¿ã£ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã§ã€ç§»å‹•å¯èƒ½ãªãƒã‚¹ã®åº§æ¨™ã®ãƒªã‚¹ãƒˆã‚’æ¸¡ã›ã°ãã“ã«ä¸¸ã‚’æ›¸ã„ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```py name=main.py hl_lines=4-10
def draw(self):
    ...
    draw_pieces(self.gameboard, piece_ID)
    # å¯èƒ½ãªç§»å‹•å…ˆã®è¡¨ç¤º
    if self.select_dest and None not in self.startpos:
        piece = self.gameboard[self.startpos]
        draw_available_moves(
            [move for move in piece.available_moves(*self.startpos, self.gameboard, color=piece.color)
                if self.is_valid_move(piece, self.startpos, move, self.gameboard)],
            opponent=self.playersturn != piece.color)
    ...
```

æ¡ä»¶æ–‡ã¯ã€è¡Œå…ˆé¸æŠä¸­ã§ã‚ã‚Šã€é–‹å§‹ä½ç½®ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã€‚

ãã‚Œã§ã€`draw_available_moves()`ã®`opponent`ã§ã¯ã€è‡ªåˆ†ã®æ‰‹ç•ªã§ã¯ãªã„ã¨ãã«ç›¸æ‰‹ã®é§’ã‚’è§¦ã£ãŸã¨ãã«`True`ã¨ãªã‚‹ã‚ˆã†ãªæ¡ä»¶å¼ã‚’ä¸ãˆã¦ã„ã¾ã™ã€‚

ãŸã ã€8-9 è¡Œç›®ã®å†…åŒ…è¡¨è¨˜ãŒé¢å€’ãã•ã„ã§ã™ã€‚

`available_moves()`ã¯ç§»å‹•å…ˆã®ãƒªã‚¹ãƒˆã‚’è¿”ã—ã¾ã™ãŒã€**ãƒã‚§ãƒƒã‚¯å›é¿ã‚’è€ƒæ…®ã—ã¦ã„ãªã„ã®ã§ã€ãã®ã¾ã¾ã§ã¯ä½¿ãˆã¾ã›ã‚“ã€‚**

ãã®ãŸã‚ã€<pstlk label="ç¬¬4å›" to="chess-app-devel-4#ç›¤é¢ã‚’ä»®å®šã™ã‚‹" />ã§ãƒã‚§ãƒƒã‚¯å›é¿ã‚’è€ƒæ…®ã—ãŸ`is_valid_move()`ã‚’ä½œã£ãŸã®ã§ã™ãŒã€

ã“ã¡ã‚‰ã¯ç§»å‹•å¯èƒ½ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹ã ã‘ã§ã€**ç§»å‹•å…ˆã®åº§æ¨™ã®ãƒªã‚¹ãƒˆã‚’è¿”ã™ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚**

ãªã‚“ã§ã“ã†ã—ãŸã‚“ã ã‚ã†ã€ã¨ã¡ã‚‡ã£ã¨å¾Œæ‚”ã€‚

ã“ã®ã¾ã¾ã«ã—ã¦ãŠã„ã¦ã‚‚é¢å€’ãªã®ã§ã€ç§»å‹•å…ˆã®åº§æ¨™ã®ãƒªã‚¹ãƒˆã‚’è¿”ã™ã‚ˆã†ã«`is_valid_move()`ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚

```py name=main.py ins=14-39 del=1-13
def is_valid_move(self, piece, startpos, endpos, gameboard):
    if endpos in piece.availableMoves(*startpos, gameboard, color=piece.color):
        # ç›¤é¢ã®è¤‡è£½
        gameboardTmp = copy(gameboard)
        # è¤‡è£½ã—ãŸç›¤é¢ã®æ›´æ–°
        self.renew_gameboard(startpos, endpos, gameboardTmp)
        # ãƒã‚§ãƒƒã‚¯åˆ¤å®š
        if self.is_check(piece.color, gameboardTmp):
            return False
        else:
            return True
    else:
        return False
def valid_moves(self, piece, startpos, gameboard):
    '''
    å‹•ã‘ã‚‹ä½ç½®ã‚’å‡ºåŠ›ï¼å‘³æ–¹é§’ä¸Šã«ã¯ç§»å‹•ä¸å¯ï¼

    Parameters
    ----------
    piece : obj
        é§’ï¼
    startpos : tuple > (int, int)
        é–‹å§‹ä½ç½®ï¼çµ¶å¯¾åº§æ¨™ï¼
    gameboard : dict > {(int, int): obj, ...}
        ç›¤é¢ï¼

    Returns
    -------
    result : list > [(int, int), ...]
    '''
    result = piece.available_moves(*startpos, gameboard, color=piece.color)
    # ãƒã‚§ãƒƒã‚¯å›é¿ã®ãŸã‚å‹•ãç¸›ã‚Š
    result_tmp = copy(result)
    for endpos in result_tmp:
        gameboard_tmp = copy(gameboard)
        self.renew_gameboard(startpos, endpos, gameboard_tmp)
        if self.is_check(piece.color, gameboard_tmp):
            result.remove(endpos)
    return result
```

ãã‚Œã«ä¼´ã£ã¦é–¢ä¿‚å„æ‰€ã®èª¿æ•´ã‚’ã—ã¾ã™ã€‚

ã¨ã“ã‚ã§ã€ãƒã‚¦ã‚¹æ“ä½œã§ã¯ç§»å‹•å¯èƒ½ãªå ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãªã„ã¨å‹•ä½œã—ãªã„ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã®ã§ã€

`main()`å†…éƒ¨ã®æ¡ä»¶å¼ã¯çœã„ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚

```py name=main.py ins=10-13,23,38-39 del=3-9,21-22,36-37
def main(self):
    ...
        if target:
            print("found "+str(target))
            if target.color != self.playersturn:
                self.message = "you aren't allowed to move that piece this turn"
            if self.is_valid_move(target, startpos, endpos, self.gameboard):
                self.message = "that is a valid move"
                ...
        if target and target.color == self.playersturn:
            print("found "+str(target))
            self.message = "that is a valid move"
            ...
...
ã€€
def draw(self):
    ...
    if self.select_dest and None not in self.startpos:
        piece = self.gameboard[self.startpos]
        draw_available_moves(
            [move for move in piece.available_moves(*self.startpos, self.gameboard, color=piece.color)
                if self.is_valid_move(piece, self.startpos, move, self.gameboard)],
            self.valid_moves(piece, self.startpos, self.gameboard),
            opponent=self.playersturn != piece.color)
        ...
...
ã€€
def mouse(self, button, state, x, y):
    ...
    # å·¦ã‚¯ãƒªãƒƒã‚¯
    if (button == GLUT_LEFT_BUTTON
            and state == GLUT_DOWN):
        try:
            # è¡Œå…ˆé¸æŠ
            if (self.select_dest
                    and self.is_valid_move(self.gameboard[self.startpos],
                        self.startpos, self.parse_mouse(), self.gameboard)):
                    and self.parse_mouse() in self.valid_moves(
                        self.gameboard[self.startpos], self.startpos, self.gameboard)):
                ...
```

ã“ã‚Œã§ãƒã‚¦ã‚¹æ“ä½œã§é§’ã‚’å‹•ã‹ã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼

<postimage src="mouse-action-result" ext="gif" alt="çµæœ" />

---

ã“ã‚Œã§çµæ§‹ã‚²ãƒ¼ãƒ ã£ã½ããªã£ã¦ãã¾ã—ãŸã­ã€‚

ãŸã ã€é§’ã®å‹•ããŒã‚«ã‚¯ã‚«ã‚¯ã—ã¦ã„ã¾ã™ã€‚

<pstlk label="æ¬¡å›" to="chess-app-devel-9" /> ã¯ãŠã¾ã‘çš„ãªæ„Ÿã˜ã§ã€é§’ã®å‹•ãã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

å‚è€ƒã«ãªã£ãŸã‚‰ã†ã‚Œã—ã„ã§ã™ã€‚

ã§ã¯ğŸ‘‹
