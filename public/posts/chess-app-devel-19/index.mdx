---
title: "ãƒã‚§ã‚¹ã‚¢ãƒ—ãƒªé–‹ç™º(19) ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã®æ‹¡å¼µï¼ˆæ›–æ˜§æ€§ã®æ’é™¤ã¨é§’ã®å†é…ç½®ï¼‰"
date: 2020-10-06T12:00:00+09:00
lastmod: 2020-11-23T12:00:00+09:00
categories: [ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°, ãƒã‚§ã‚¹ã‚¢ãƒ—ãƒªé–‹ç™º]
tags: [ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°, Python, OpenGL, ã‚¢ãƒ—ãƒªé–‹ç™º, ãƒã‚§ã‚¹]
draft: false
---

Python ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å‹•ã‹ã™ãƒ•ã‚§ã‚¢ãƒªãƒ¼ãƒã‚§ã‚¹ã‚¢ãƒ—ãƒªé–‹ç™ºã€é€£è¼‰ç¬¬ 19 å›ã§ã™ã€‚

<pstlk label="å‰å›" to="chess-app-devel-18" />ã¯ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã®æ¡ä»¶åˆ¤å®šã®ã‚³ãƒ¼ãƒ‰ã‚’ç·¨é›†ã—ã¾ã—ãŸã€‚

ä»Šå›ã¯æ›–æ˜§ãªå ´åˆã«ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã™ã‚‹ã‹ã©ã†ã‹ã®ç¢ºèªã‚’ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã€ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°æ™‚ã®é§’ã®å†é…ç½®ã®ã‚³ãƒ¼ãƒ‰ã®ç·¨é›†ã‚‚ã—ã¦ã„ãã¾ã™ã€‚

<!--more-->

<br/>

## ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã™ã‚‹ã‹ã©ã†ã‹ç¢ºèª

ã‚­ãƒ³ã‚°ãŒãƒ«ãƒ¼ã‚¯æ–¹å‘ã«ï¼‘æ­©ã ã‘å‹•ã„ãŸã¨ãã€

ãã‚ŒãŒã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã‚’æ„å›³ã—ã¦ã®ã‚‚ã®ã‹ã€ã¯ãŸã¾ãŸå˜ã«å‹•ã„ãŸã ã‘ãªã®ã‹ãŒæ›–æ˜§ã§ã™ã€‚

ã“ã‚Œã‚’ã¯ã£ãã‚Šã•ã›ã‚‹ãŸã‚ã«ã€ã€Œãã®å‹•ãã¯ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã‚’æ„å›³ã—ã¦ã„ã¾ã™ã‹ï¼Ÿã€ã¨ãƒ¦ãƒ¼ã‚¶ã«å°‹ã­ã‚‹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã•ã›ã¾ã™ã€‚

ã“ã®è¡¨ç¤ºã«ã¯ã€<pstlk label="ç¬¬11å›" to=""chess-app-devel-11/#é¸æŠè‚¢ã‚’è¡¨ç¤ºã™ã‚‹å¹ãå‡ºã—ã‚’æç”»"" />ã§ä½œæˆã—ãŸå¹ãå‡ºã—ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

<br/>

ã¾ãšã€ç¢ºèªãŒå¿…è¦ãªå ´åˆã¨ãã†ã§ãªã„å ´åˆãŒã‚ã‚‹ã®ã§ã€ç¢ºèªãŒå¿…è¦ã‹ã©ã†ã‹ã‚’ç¤ºã™å¤‰æ•°ã€

ãã—ã¦ç¢ºèªã®çµæœã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã™ã‚‹ã“ã¨ã‚’é¸æŠã—ãŸã‹ã‚’ç¤ºã™å¤‰æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚

```py {name="main.py", hl_lines=["7-10"]}
class Game:
    def __init__(self):
        ...
        # ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°
        # ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ãŒæ®‹ã£ã¦ã„ã‚‹ã‹
        self.can_castling = {'W': [True, True], 'B': [True, True]}
        # ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã™ã‚‹ã‹ã©ã†ã‹ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ç¢ºèªã™ã‚‹ã‹
        self.confirm_castling = False
        # ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã§ãã‚‹çŠ¶æ…‹ã«ã‚ã‚‹ã‹
        self.do_castling = False
        ...
```

ç¢ºèªãŒå¿…è¦ãªå ´åˆã¨ã¯æ›–æ˜§ãªå ´åˆã€ã¤ã¾ã‚Šã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°å®Œäº†ä½ç½®ã«ã‚­ãƒ³ã‚°ãŒãŸã ï¼‘æ­©å‹•ã„ãŸå ´åˆã§ã™ã®ã§ã€

ã“ã®ã¨ãã®æ¡ä»¶ã‚’è¨˜è¿°ã—ã¦ã„ãã¾ã™ã€‚

```py {name="main.py"}
class Game:
    ...
    def castle_or_not(self, piece, endpos):
        '''
        ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã™ã‚‹ã‹ã—ãªã„ã‹ã‚’ç¢ºèªã™ã‚‹ã‹

        Parameters
        ----------
        piece : obj
            é§’ï¼
        endpos : tuple > (int, int)
            çµ‚äº†ä½ç½®ï¼çµ¶å¯¾åº§æ¨™ï¼

        Notes
        -----
        ifæ–‡ã®æ¡ä»¶å¼ã«ã¤ã„ã¦ï¼

        ã‚­ãƒ³ã‚°ã®ç§»å‹•çµ‚äº†ä½ç½®ãŒï¼Œã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°çµ‚äº†ä½ç½®ã¨ã—ã¦ã‚ã‚Šã†ã‚‹4ã¤ã®ä½ç½®ã®ã†ã¡ã®ã„ãšã‚Œã‹ã«ã‚ã¦ã¯ã¾ã‚‹
        and (ã‚¯ã‚¤ãƒ¼ãƒ³ã‚µã‚¤ãƒ‰ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã®æ¡ä»¶ã«ã‚ã¦ã¯ã¾ã‚‹
            or ã‚­ãƒ³ã‚°ã‚µã‚¤ãƒ‰ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã®æ¡ä»¶ã«ã‚ã¦ã¯ã¾ã‚‹)
        and ã‚­ãƒ³ã‚°ã®åˆæœŸä½ç½®ã¨ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°çµ‚äº†ä½ç½®ã®xåº§æ¨™ã®å·® == 1
        and ç§»å‹•å…ˆã«é§’ãŒãªã„ï¼ˆï¼ã‚­ãƒ³ã‚°ãŒæ•µé§’ã‚’å–ã£ãŸã®ã§ã¯ãªã„ï¼‰
        '''
        if (endpos in [(2, 0), (self.kind.size - 2, 0), (2, self.kind.size - 1), (self.kind.size - 2, self.kind.size - 1)]
                and (self.castling_requirements(piece, endpos, 0, self.gameboard)
                    or self.castling_requirements(piece, endpos, 1, self.gameboard))
                and abs(self.kind.placers[1].index(King) - endpos[0]) == 1
                and endpos not in self.gameboard):
            self.confirm_castling = True
```

æ¬¡ã«ã€ã“ã®åˆ¤å®šã‚’ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯æ™‚ã«è¡Œã‚ã›ã€

```py {name="main.py"}
class Game:
    ...
    def mouse(self, button, state, x, y):
        ...
                    # é§’é¸æŠ
                    elif (self.parse_mouse() in self.gameboard
                            and not self.prom and not self.confirm_castling):
            ...
            # ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã™ã‚‹ã‹ã—ãªã„ã‹ã®ç¢ºèª
            if self.kind.castling:
                if self.startpos in self.gameboard:
                    self.castle_or_not(
                        self.gameboard[self.startpos], self.endpos)
        ...
```

ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã‚’ç¢ºèªã™ã‚‹ã¨ãã«ã¯ã€å¹ãå‡ºã—ã¨ãƒœã‚¿ãƒ³ã§ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½œæˆã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚

```py {name="utils.py"}
def draw_castling_confirmation(endpos):
    '''ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹'''
    draw_balloon(*endpos)
    glColor(1.0, 1.0, 1.0)
    draw_str(2.0, 4.0, 'Castling?')
    draw_button(1.5, 3.0, 3.0, 3.5, 'Yes',
                (1.0, 1.0, 1.0), (0.0, 0.0, 0.0))
    draw_button(4.0, 5.5, 3.0, 3.5, 'No',
                (1.0, 1.0, 1.0), (0.0, 0.0, 0.0))
```

```py {name="main.py"}
class Game:
    ...
    def draw(self):
        ...
            if self.time == 1 and not self.confirm_castling:
                self.main()
        ...
            # ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã™ã‚‹ã‹ã©ã†ã‹ã®ç¢ºèª
            if self.confirm_castling:
                draw_castling_confirmation(self.endpos)
        ...
```

è¡¨ç¤ºã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã§ã€ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã®æ„å›³ãŒã‚ã‚‹ã‹ã©ã†ã‹ãŒç¢ºèªã§ãã¾ã™ã€‚

```py {name="main.py", hl_lines=["10-22"]}
class Game:
    ...
    def mouse(self, button, state, x, y):
        ...
            # ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã™ã‚‹ã‹ã—ãªã„ã‹ã®ç¢ºèª
            if self.kind.castling:
                if self.startpos in self.gameboard:
                    self.castle_or_not(
                        self.gameboard[self.startpos], self.endpos)
                if self.confirm_castling:
                    if on_square(*self.mousepos, 1.5, 3.0, 3.0, 4.0):
                        self.do_castling = True
                        self.confirm_castling = False
                        self.time = 0
                        self.moving = True
                        glutIdleFunc(self.idle_move)
                    if on_square(*self.mousepos, 4.0, 5.5, 3.0, 4.0):
                        self.do_castling = False
                        self.confirm_castling = False
                        self.time = 0
                        self.moving = True
                        glutIdleFunc(self.idle_move)
        ...
```

ã“ã‚Œã§ç¢ºèªãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

<postimage src="castling_confirmation" alt="ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ç¢ºèª" />

<br/>

## é§’ã®å†é…ç½®

ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã—ãŸå¾Œã«ã¯ã€ãƒ«ãƒ¼ã‚¯ãŒç‰¹å®šã®ä½ç½®ã«ç§»å‹•ã—ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ã‚‚ã¨ã®ä½ç½®ã«ã‚ã£ãŸé§’ï¼ˆï¼ãƒ«ãƒ¼ã‚¯ï¼‰ã‚’å‰Šé™¤ã—ã¦ç‰¹å®šã®ä½ç½®ã«å†é…ç½®ã—ã¦ã„ã¾ã™ã€‚

```py {name="main.py"}
def renew_gameboard(self, startpos, endpos, gameboard):
    '''
    ç›¤é¢ã‚’æ›´æ–°ã™ã‚‹

    Parameters
    ----------
    startpos, endpos : tuple > (int, int)
        é–‹å§‹ä½ç½®ï¼Œçµ‚äº†ä½ç½®ï¼çµ¶å¯¾åº§æ¨™ï¼
    gameboard : dict > {(int, int): obj, ...}
        ç›¤é¢ï¼
    '''
    color = gameboard[startpos].color
    gameboard[endpos] = gameboard[startpos]
    del gameboard[startpos]
    ...
    # ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°
    if (gameboard[endpos].abbr == 'K'
            and abs(startpos[0] - endpos[0]) == 2):
        # ã‚¯ã‚¤ãƒ¼ãƒ³ã‚µã‚¤ãƒ‰
        # ç™½
        if endpos == (2, 0):
            del gameboard[(0, 0)]
            gameboard[(3, 0)] = Rook('W')
        # é»’
        if endpos == (2, 7):
            del gameboard[(0, 7)]
            gameboard[(3, 7)] = Rook('B')
        # ã‚­ãƒ³ã‚°ã‚µã‚¤ãƒ‰
        # ç™½
        if endpos == (6, 0):
            del gameboard[(7, 0)]
            gameboard[(5, 0)] = Rook('W')
        # é»’
        if endpos == (6, 7):
            del gameboard[(7, 7)]
            gameboard[(5, 7)] = Rook('B')
```

ã¾ãšé§’ã®ç§»å‹•å…ˆã«ç§»å‹•å‰ã®é§’<tltp label="ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹">ã‚¯ãƒ©ã‚¹ã‚’ã‚‚ã¨ã«ä½œã‚‰ã‚ŒãŸå®Ÿä½“</tltp>ã‚’ç§»ã—ã¦ã‹ã‚‰ã€ã‚‚ã¨ã®ä½ç½®ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™ï¼ˆã‚­ãƒ³ã‚°ã®å‹•ãï¼‰ã€‚

ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ãŒèµ·ã“ã‚‹ã®ã¯ã‚­ãƒ³ã‚°ãŒï¼’æ­©å‹•ã„ãŸã¨ãã®ã¿ã§ã‚ã‚‹ã“ã¨ã‚’åˆ©ç”¨ã—ã¦æ¡ä»¶æ–‡ã‚’ç«‹ã¦ã€

ä½ç½®ã«ã‚ˆã£ã¦ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ãŒèµ·ã“ã‚‹ç®‡æ‰€ã‚’åˆ¤å®šã—ã€ãƒ«ãƒ¼ã‚¯ã‚’æ¶ˆã—ã¦åˆ¥ã®ä½ç½®ã«æ–°ãŸãªãƒ«ãƒ¼ã‚¯ã‚’ç½®ã„ã¦ã„ã¾ã™ï¼ˆãƒ«ãƒ¼ã‚¯ã®å‹•ãï¼‰ã€‚

<br/>

ã‚­ãƒ³ã‚°ã®å‹•ãã«é–¢ã—ã¦ã¯ã€ã‚­ãƒ³ã‚°ãŒï¼‘æ­©ã‚‚å‹•ã‹ãªã„ã“ã¨ã‚‚ã‚ã‚Šãˆã‚‹ã®ã§ã€`startpos != endpos`ã®ã¨ãã®ã¿`del gameboard[startpos]`ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

ãã†ã—ãªã„ã¨ã‚­ãƒ³ã‚°ãŒæ¶ˆãˆã¦ã—ã¾ã†ã‹ã‚‰ã§ã™ã€‚

ãƒ«ãƒ¼ã‚¯ã®å‹•ãã®ã»ã†ã¯ã€ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ç™ºç”Ÿã®æ¡ä»¶ã‚’ä¸»ã«`do_castling`ã«ã‚ˆã£ã¦åˆ¤å®šã—ã€

ãƒ«ãƒ¼ã‚¯ã®åˆæœŸä½ç½®ã«ã‚ã‚‹é§’ãŒãƒ«ãƒ¼ã‚¯ã§ã‚ã‚Œã°ã€ãã®é§’ã‚’æ¶ˆã—ã¦æ–°ãŸãªãƒ«ãƒ¼ã‚¯ã‚’ç½®ã„ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚’ã‚‚ã¨ã«æ‹¡å¼µã—ã¦æ›¸ãæ›ãˆã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```py {name="main.py"}
def renew_gameboard(self, startpos, endpos, gameboard):
    '''
    ç›¤é¢ã‚’æ›´æ–°ã™ã‚‹

    Parameters
    ----------
    startpos, endpos : tuple > (int, int)
        é–‹å§‹ä½ç½®ï¼Œçµ‚äº†ä½ç½®ï¼çµ¶å¯¾åº§æ¨™ï¼
    gameboard : dict > {(int, int): obj, ...}
        ç›¤é¢ï¼
    '''
    color = gameboard[startpos].color
    gameboard[endpos] = gameboard[startpos]
    del gameboard[startpos]
    if startpos != endpos:
        del gameboard[startpos]
    ...
    # ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°
    # ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã§ãã‚‹ã‚²ãƒ¼ãƒ ã§ã‚ã‚‹
    # ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ç¢ºèªä¸­ã§ãªã„
    # ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã§ãã‚‹
    # çµ‚äº†ä½ç½®æŒ‡å®šãŒã‚ã‚‹
    if (self.kind.castling
            and not self.confirm_castling
            and self.do_castling
            and None not in endpos):
        rook_init_pos = [pos for pos, piece in enumerate(self.kind.placers[1])
            if piece == Rook]
        size = self.kind.size
        piece = gameboard[endpos]
        # ã‚¯ã‚¤ãƒ¼ãƒ³ã‚µã‚¤ãƒ‰
        rook_pos = rook_init_pos[0]
        # ç™½
        if (endpos == (2, 0)
                and piece.color == 'W'
                and (rook_pos, 0) in gameboard):
            if gameboard[(rook_pos, 0)].abbr == 'R':
                del gameboard[(rook_pos, 0)]
            gameboard[(3, 0)] = Rook('W')
        # é»’
        if (endpos == (2, size - 1)
                and piece.color == 'B'
                and (rook_pos, size - 1) in gameboard):
            if gameboard[(rook_pos, size - 1)].abbr == 'R':
                del gameboard[(rook_pos, size - 1)]
            gameboard[(3, size - 1)] = Rook('B')
        # ã‚­ãƒ³ã‚°ã‚µã‚¤ãƒ‰
        rook_pos = rook_init_pos[1]
        # ç™½
        if (endpos == (size - 2, 0)
                and piece.color == 'W'
                and (rook_pos, 0) in gameboard):
            if gameboard[(rook_pos, 0)].abbr == 'R':
                del gameboard[(rook_pos, 0)]
            gameboard[(size - 3, 0)] = Rook('W')
        # é»’
        if (endpos == (size - 2, size - 1)
                and piece.color == 'B'
                and (rook_pos, size - 1) in gameboard):
            if gameboard[(rook_pos, size - 1)].abbr == 'R':
                del gameboard[(rook_pos, size - 1)]
            gameboard[(size - 3, size - 1)] = Rook('B')
```

ã“ã‚Œã§ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã®æ›–æ˜§æ€§ã®æ’é™¤ã€ãã—ã¦é§’ã®å†é…ç½®ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

<video src="castling1" />

<video src="castling2" />

<br/>

ã“ã“æ•°å›åˆ†ã®å¤‰æ›´ã¯ [GitHub](https://github.com/midorimici/chess-program-for-python-and-OpenGL/commit/06886ba60cbe2856db1e7cc52bc9fba67693c328#diff-6707418c2a43eec365d78e30985aafe1) ã§è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---

ãƒ•ã‚§ã‚¢ãƒªãƒ¼ãƒã‚§ã‚¹ãŒä½œã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã€

ã‚²ãƒ¼ãƒ ã«ã‚ˆã£ã¦å‡ºç¾ã™ã‚‹é§’ãŒå¤‰ã‚ã‚‹ã®ã§ã€

<pstlk label="æ¬¡å›" to="chess-app-devel-20" />ã¯ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã®æ‹¡å¼µã«ã¤ã„ã¦æ›¸ããŸã„ã¨æ€ã„ã¾ã™ã€‚

ãŠèª­ã¿ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï½

ã§ã¯ã¾ãŸğŸ‘‹
