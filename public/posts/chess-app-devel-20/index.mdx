---
title: "ãƒã‚§ã‚¹ã‚¢ãƒ—ãƒªé–‹ç™º(20) ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã®æ‹¡å¼µ"
date: 2020-11-23T12:00:00+09:00
lastmod: 2020-12-07T12:00:00+09:00
categories: [ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°, ãƒã‚§ã‚¹ã‚¢ãƒ—ãƒªé–‹ç™º]
tags: [ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°, Python, ã‚¢ãƒ—ãƒªé–‹ç™º, ãƒã‚§ã‚¹]
draft: false
---

Python ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å‹•ã‹ã™ãƒ•ã‚§ã‚¢ãƒªãƒ¼ãƒã‚§ã‚¹ã‚¢ãƒ—ãƒªé–‹ç™ºã€é€£è¼‰ç¬¬ 20 å›ã§ã™ã€‚

<pstlk label="å‰å›" to="chess-app-devel-19" />ã§ãƒ•ã‚§ã‚¢ãƒªãƒ¼ãƒã‚§ã‚¹ã¸ã®ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã®æ‹¡å¼µãŒå®Œäº†ã—ã¾ã—ãŸã€‚

ä»Šå›ã¯ãƒãƒ¼ãƒ³ã®ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã®æ‹¡å¼µã‚’ã—ã¦ã„ãã¾ã™ã€‚

<!--more-->

æ‹¡å¼µå‰ã®ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…ã¯ç¬¬11å›ã«è¼‰ã›ã¦ã„ã¾ã™ã€‚

{{< relpos chess-app-devel-11 >}}

<br/>

## ã‚²ãƒ¼ãƒ æ¯ã«ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å…ˆå€™è£œã‚’æŒ‡å®š

ã¾ãšã¯ã‚²ãƒ¼ãƒ ã«ã‚ˆã£ã¦ç•°ãªã‚‹ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å…ˆå€™è£œã‚’ã€å„ã‚²ãƒ¼ãƒ ã‚¯ãƒ©ã‚¹ã®
<tltp label="ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå‚ç…§ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿</tltp>
ã¨ã—ã¦å®šç¾©ã™ã‚‹ã“ã¨ãŒå¿…è¦ã§ã™ã€‚

ã“ã‚Œã¯<pstlk label="ç¬¬15å›" to=""chess-app-devel-15/#ã‚²ãƒ¼ãƒ ã‚’å®šç¾©ã™ã‚‹"" />ã§ã™ã§ã«å®Œäº†ã—ã¦ã„ã¾ã™ã€‚

```py {name="games.py", hl_lines=[7, 8]}
class Normal:
    '''é€šå¸¸ã®ãƒã‚§ã‚¹'''
    # ç›¤é¢ã®ã‚µã‚¤ã‚º
    size = 8
    # ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã®æœ‰ç„¡
    castling = True
    # ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å…ˆ
    promote2 = [Knight, Bishop, Rook, Queen]
    # é§’ã®é…ç½®
    placers = {1: [Rook, Knight, Bishop, Queen, King, Bishop, Knight, Rook],
        2: [Pawn] * size}
    # ç”»åƒIDã®å‰²ã‚Šå½“ã¦
    ID = {}
    for rk in placers:
        for fl in range(size):
            if placers[rk][fl] is not None:
                ID['W' + placers[rk][fl].abbr] = size * rk + fl
                ID['B' + placers[rk][fl].abbr] = -(size * rk + fl)
```

`promote2`ã¨ã„ã†ãƒªã‚¹ãƒˆã®ä¸­ã‹ã‚‰ãƒãƒ¼ãƒ³ã®ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å…ˆãŒé¸æŠã•ã‚Œã¾ã™ã€‚

<br/>

## ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã«è¡¨ç¤ºã™ã‚‹é¸æŠè‚¢ã‚’ä¸€èˆ¬åŒ–

æ¬¡ã«ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã®é¸æŠè‚¢ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹é§’ã‚’ã€ã“ã®ãƒªã‚¹ãƒˆã«åˆã‚ã›ã¦å¤‰æ›´ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

ç¾åœ¨ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³é¸æŠè‚¢ã®è¡¨ç¤ºéƒ¨åˆ†ã®ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```py {name="main.py", hl_lines=["12-15"]}
...
class Game:
    ...
    def draw(self):
        '''æç”»ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯'''
        ...
            # ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³
            if self.prom:
                draw_balloon(*self.endpos)
                piece_color = self.gameboard[self.endpos].color
                glEnable(GL_TEXTURE_2D)
                draw_img(2.0, 3.5, piece_ID[piece_color + 'N'])
                draw_img(3.0, 3.5, piece_ID[piece_color + 'B'])
                draw_img(4.0, 3.5, piece_ID[piece_color + 'R'])
                draw_img(5.0, 3.5, piece_ID[piece_color + 'Q'])
                glDisable(GL_TEXTURE_2D)
            ...
```

12-15è¡Œç›®ãŒãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å…ˆã‚’å›ºå®šã—ã¦ã—ã¾ã£ã¦ã„ã‚‹ã®ã§ã€ã“ã®éƒ¨åˆ†ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

ã©ã®ä½ç½®åº§æ¨™ã«ã©ã®é§’ã®ç”»åƒã‚’é…ç½®ã™ã‚‹ã‹ã‚‚ã‚²ãƒ¼ãƒ ã«ã‚ˆã£ã¦å¤‰åŒ–ã—ã¾ã™ã®ã§ã€

è¡¨ç¤ºå¹…ã¯ 4 åˆ—ã¾ã§ã¨ã—ã¦è¡Œã‚’å¢—ã‚„ã—ã¦ã„ãå½¢ã§æç”»ã—ã¾ã™ã€‚

```py {name="main.py", hl_lines=["6-14"], ins=["4-8"], del=["0-3"]}
# ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³
if self.prom:
    draw_balloon(*self.endpos)
    piece_color = self.gameboard[self.endpos].color
    glEnable(GL_TEXTURE_2D)
    draw_img(2.0, 3.5, piece_ID[piece_color + 'N'])
    draw_img(3.0, 3.5, piece_ID[piece_color + 'B'])
    draw_img(4.0, 3.5, piece_ID[piece_color + 'R'])
    draw_img(5.0, 3.5, piece_ID[piece_color + 'Q'])
    for i in range(len(self.kind.promote2)):
        draw_img(2.0 + i % 4,
            3.5 + ((len(self.kind.promote2) - 1)//4)/2 - i//4,
            self.kind.ID[piece_color +
                self.kind.promote2[i].abbr])
    glDisable(GL_TEXTURE_2D)
```

<br/>

ã¾ãŸã€ãã‚Œã«ä¼´ã£ã¦å¹ãå‡ºã—ã®ç¸¦å¹…ã‚‚å¢—ã‚„ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

å¹ãå‡ºã—ã¯`draw_balloon`é–¢æ•°ãŒæç”»ã—ã¦ã„ã¾ã™ã®ã§ã€ãã¡ã‚‰ã®ä¸­èº«ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚

```py {name="utils.py", hl_lines=["1-2", "10-11", "15-22"], ins=["1-3", "8-11"], del=[0, "4-7"], inline_hl=[1:["6-9"], 6:["2-4"], 7:["2-4"], 8:["5-15"], 9:["5-15"], 10:["2-23"], 11:["2-23"]]}
def draw_balloon(x, y):
def draw_balloon(x, y, num=4):
    '''
    ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¨ãã®å¹ãå‡ºã—ã‚’æç”»ã™ã‚‹

    Parameters
    ----------
    x, y : int
        é§’ã®åº§æ¨™ï¼
    num : int, default 4
        ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³é¸æŠè‚¢æ•°ï¼
    '''
    glColor(0.5, 0.5, 0.5)  # è‰²ã®æŒ‡å®š
    glBegin(GL_QUADS)       # å››è§’å½¢ã‚’æç”»
    glVertex(1.0, 2.5)
    glVertex(1.0, 4.5)
    glVertex(6.0, 4.5)
    glVertex(6.0, 2.5)
    glVertex(1.0, 2.5 - ((num - 1) // 4) / 2)
    glVertex(1.0, 4.5 + ((num - 1) // 4) / 2)
    glVertex(2.0 + num if num <= 4 else 6.0, 4.5 + ((num - 1) // 4) / 2)
    glVertex(2.0 + num if num <= 4 else 6.0, 2.5 - ((num - 1) // 4) / 2)
    glEnd()
    glBegin(GL_TRIANGLES)   # ä¸‰è§’å½¢ã‚’æç”»
    glVertex(3.0, 3.5)
    glVertex(4.0, 3.5)
    glVertex(x, y)
    glEnd()
```

`glBegin`ã‹ã‚‰`glEnd`ã¾ã§ã®é–“ã®ï¼”ã¤ã®`glVertex`ãŒå››è§’å½¢ã®å„é ‚ç‚¹ã®ä½ç½®ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

æ–°ãŸã«è¿½åŠ ã„ãŸå¼•æ•°`num`=ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³é¸æŠè‚¢ã®æ•°ã«ã‚ˆã£ã¦ã“ã®åº§æ¨™ã‚’èª¿æ•´ã—ã¦ã„ã¾ã™ã€‚

`(num - 1) // 4`ã¯`num`ãŒ`4`ã¾ã§ã®ã¨ã`0`ã€`8`ã¾ã§ã®ã¨ã`1`ã¨ã„ã†ã‚ˆã†ã«å¢—ãˆã¦ã„ãã®ã§ã€

ç¸¦æ–¹å‘ã®åº§æ¨™`2.5`ã¨`4.5`ã‚’åŸºæº–ã«ç¸¦å¹…ãŒå¢—ãˆã¦ã„ãã“ã¨ã«ãªã‚Šã¾ã™ã€‚

æ¨ªå¹…ã¯`2.0 + num if num <= 4 else 6.0`ã¨ã„ã†ãµã†ã«ã€é¸æŠè‚¢ãŒï¼”ã¤ä»¥ä¸‹ã‹ã©ã†ã‹ã§å¤‰ãˆã¦ã„ã¾ã™ã€‚

<br/>

å¹ãå‡ºã—æç”»éƒ¨åˆ†ã®ã‚³ãƒ¼ãƒ‰ã‚‚å¤‰æ›´ã—ã¾ã™ã€‚

```py {name="main.py", hl_lines=["3-4"], ins=[1], del=[0], inline_hl=[1:["6-16"]]}
# ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³
if self.prom:
    draw_balloon(*self.endpos)
    draw_balloon(*self.endpos, num=len(self.kind.promote2))
    piece_color = self.gameboard[self.endpos].color
    glEnable(GL_TEXTURE_2D)
    for i in range(len(self.kind.promote2)):
        draw_img(2.0 + i % 4,
            3.5 + ((len(self.kind.promote2) - 1)//4)/2 - i//4,
            self.kind.ID[piece_color +
                self.kind.promote2[i].abbr])
    glDisable(GL_TEXTURE_2D)
```

ã“ã‚Œã§é€šå¸¸ã®ã‚²ãƒ¼ãƒ ã®ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã€

<postimage src="prom1" alt="ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³1" />

ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³ãŒåŠ ã‚ã£ãŸã‚²ãƒ¼ãƒ ï¼ˆ`promote2 = [Knight, Bishop, Rook, Queen, Unicorn]`ï¼‰ã§ã¯ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

<postimage src="prom2" alt="ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³2" />

ç¸¦å¹…ãŒå¤§ãããªã‚Šã¾ã—ãŸã€‚

<br/>

## ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯ã‚’èª¿æ•´

ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯ã§ã“ã®é¸æŠè‚¢ã®ä¸­ã‹ã‚‰é§’ã‚’é¸æŠã™ã‚‹ã‚ã‘ã§ã™ãŒã€ä»Šã®ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```py {name="main.py", hl_lines=["12-23"]}
...
class Game:
    ...
    def mouse(self, button, state, x, y):
        '''
        ãƒã‚¦ã‚¹å…¥åŠ›ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
        '''
        ...
            # ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³
            if self.prom:
                piece_color = self.gameboard[self.endpos].color
                if on_square(*self.mousepos, 1.5, 2.5, 3.0, 4.0):
                    self.gameboard[self.endpos] = Knight(piece_color)
                    self.prom = False
                if on_square(*self.mousepos, 2.5, 3.5, 3.0, 4.0):
                    self.gameboard[self.endpos] = Bishop(piece_color)
                    self.prom = False
                if on_square(*self.mousepos, 3.5, 4.5, 3.0, 4.0):
                    self.gameboard[self.endpos] = Rook(piece_color)
                    self.prom = False
                if on_square(*self.mousepos, 4.5, 5.5, 3.0, 4.0):
                    self.gameboard[self.endpos] = Queen(piece_color)
                    self.prom = False
            ...
```

åº§æ¨™ã‚‚é§’ã‚‚å›ºå®šã«ãªã£ã¦ã„ã¾ã™ã®ã§ã€ã“ã‚Œã‚’å¤‰æ›´ã—ã¾ã™ã€‚

```py {name="main.py", hl_lines=["4-11"]}
# ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³
if self.prom:
    piece_color = self.gameboard[self.endpos].color
    for i in range(len(self.kind.promote2)):
        if on_square(*self.mousepos,
                        1.5 + i % 4,
                        2.5 + i % 4,
                        3.0 + ((len(self.kind.promote2) - 1)//4)/2 - i//4,
                        4.0 + ((len(self.kind.promote2) - 1)//4)/2 - i//4):
            self.gameboard[self.endpos] = self.kind.promote2[i](piece_color)
            self.prom = False
```

`on_square`é–¢æ•°ã®æœ€å¾Œã®ï¼”ã¤ã®å¼•æ•°`left, right, bottom, top`ãŒæœ‰åŠ¹ç¯„å›²ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

ã“ã®ç¯„å›²å†…ã«`self.mousepos`=ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ãŒã‚ã‚Œã°ã€ãƒãƒ¼ãƒ³ãŒæŒ‡å®šã®é§’ã«ç½®ãæ›ã‚ã‚Šã¾ã™ã€‚

<br/>

ã“ã‚Œã§ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã®æ‹¡å¼µãŒå®Œäº†ã—ã¾ã—ãŸï¼

ä»Šå›ã®å¤‰æ›´ã‚‚ [GitHub](https://github.com/midorimici/chess-program-for-python-and-OpenGL/commit/9c258e1aea99093d34222f4ca29aa200c1057376) ã«ä¸Šã’ã¦ãŠãã¾ã™ã€‚

---

ã“ã‚Œã¾ã§20å›ã‹ã‘ã¦ãƒã‚§ã‚¹ã®ã‚³ãƒ¼ãƒ‰ã®ç·¨é›†ã‚„ãƒ•ã‚§ã‚¢ãƒªãƒ¼ãƒã‚§ã‚¹ã¸ã®æ‹¡å¼µã‚’ã‚„ã£ã¦ãã¾ã—ãŸã€‚

ã“ã‚Œã«ã•ã‚‰ã«ãƒã‚§ãƒƒã‚¯ã‚„ãƒ¡ã‚¤ãƒˆã‚’çŸ¥ã‚‰ã›ã‚‹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ãŸã‚Šã€æ‰‹æ•°ã‚’æˆ»ã›ã‚‹ã‚ˆã†ã«ã—ãŸã‚Šã€

ã‚ã‚‹ã„ã¯ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿å¯¾æˆ¦ã‚’å°å…¥ã—ã¦ã‚‚é¢ç™½ã„ã§ã—ã‚‡ã†ã€‚

ãŒã€ã„ã£ãŸã‚“ã“ã®ã‚·ãƒªãƒ¼ã‚ºã¯ä¸€åŒºåˆ‡ã‚Šã¤ã„ãŸã“ã¨ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ãŠèª­ã¿ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï½

ã§ã¯ğŸ‘‹
